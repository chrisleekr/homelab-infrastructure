---
- name: Check if cilium is already installed
  ansible.builtin.command: kubectl get deployment cilium-operator -n kube-system
  register: kubeadm_server_cilium_check
  changed_when: kubeadm_server_cilium_check.rc != 0
  ignore_errors: true

- name: Install cilium
  when: kubeadm_server_cilium_check.rc != 0
  block:
    - name: Install Cilium
      ansible.builtin.command: cilium install --helm-set securityContext.privileged=true
      register: kubeadm_server_cilium_install
      changed_when: kubeadm_server_cilium_install.rc != 0

    - name: Wait for Cilium status to be ready
      ansible.builtin.command: cilium status --wait
      register: kubeadm_server_cilium_status
      changed_when: kubeadm_server_cilium_status.rc != 0
